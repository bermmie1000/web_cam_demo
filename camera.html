<!-- src/camera/camera.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* src/camera/css/style.css ë‚´ìš© */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        /* ì¹´ë©”ë¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #camera-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            aspect-ratio: 4 / 4;
            overflow: hidden;
        }

        /* ì¹´ë©”ë¼ ë·° ë° ìº¡ì²˜ëœ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #cameraview,
        #capturedImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ìº¡ì²˜ëœ ì´ë¯¸ì§€ ìœ„ì¹˜ ì¡°ì ˆ */
        #capturedImage {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        #captureBtn,
        #retakeBtn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            background: none;
            border: none;
            cursor: pointer;
            /* background-color: white; */
        }

        #captureBtn img,
        #retakeBtn img {
            width: 40px;
            height: 40px;
        }

        #retakeBtn {
            display: none;
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        /* #button-container button {
            position: absolute;
            bottom: 300px;
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
        } */

        /* #button-container button {
            margin: 0 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: none;
            color: white;
            cursor: pointer;
        } */

        #captureBtn button img {
            width: 10px;
            height: 10px;
        }

        #captureBtn button:active {
            background-color: grey;
        }

        #response {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: green;
        }
    </style>
</head>

<body>
    <div id="camera-container">

        <video id="cameraview" autoplay playsinline></video>
        <img id="capturedImage" />

        <button id="captureBtn">
            <img src="https://github.com/bermmie1000/img/blob/main/capture.png?raw=true" alt="Capture">
        </button>

        <button id="retakeBtn" style="display: none;">
            <img src="https://github.com/bermmie1000/img/blob/main/re_capture.png?raw=true" alt="Retake">
        </button>

    </div>
    <canvas id="canvas" style="display: none;"></canvas>
    <div id="response"></div>

    <script>
        var streamVideo;
        var cameraView = document.getElementById("cameraview");
        var capturedImage = document.getElementById("capturedImage");

        var canvas = document.getElementById("canvas");

        var responseDiv = document.getElementById("response");

        var captureBtn = document.getElementById("captureBtn");
        var retakeBtn = document.getElementById("retakeBtn");

        let imageCapture;
        let track;

        const uuid = "{{uuid}}";
        const api_url = "{{api_url}}";

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Media Device not supported");
        } else {
            openCamera();
        }


        function openCamera() {
            navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 3840 },
                    height: { ideal: 2160 },
                    aspectRatio: 4 / 4, // ì¹´ë©”ë¼ í™”ë©´ ë¹„ìœ¨
                    facingMode: { ideal: "environment" } // í›„ë©´ ì¹´ë©”ë¼ ì‚¬ìš©
                },
                audio: false
            }).then(stream => {
                streamVideo = stream;
                cameraView.srcObject = stream;
                track = stream.getVideoTracks()[0];
                imageCapture = new ImageCapture(track);

                cameraView.addEventListener('click', () => {
                    const capabilities = track.getCapabilities();

                    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                        track.applyConstraints({
                            advanced: [{ focusMode: 'continuous' }]
                        }).then(() => {
                            console.log('Focus adjusted automatically.');
                        }).catch(error => {
                            console.error('Failed to adjust focus:', error);
                        });
                    } else {
                        console.log('Automatic focus adjustment is not supported on this device.');
                    }
                });
            }).catch(error => {
                console.error("Device's Camera Access Error:", error);
            });
        }


        function sendFormDataToAPI(formData) {
            retakeBtn.disabled = true;
            retakeBtn.style.display = 'none';

            responseDiv.innerText = 'ğŸš€ Please wait...!\nSearching for matching product.';

            fetch(`${api_url}/object_detection`, {
                method: 'POST',
                body: formData // data to post
            })
                .then(response => response.json())

                .then(data => {
                    retakeBtn.disabled = false;
                    retakeBtn.style.display = 'inline-block';

                    console.log(data);

                    if (data.item_code) {
                        responseDiv.innerText = data.item_code;
                    } else {
                        responseDiv.innerText = 'Is your scan not working?';
                        responseDiv.innerText += '\nPlease make sure to check the following.';
                        responseDiv.innerText += '\n';
                        responseDiv.innerText += '\n';
                        responseDiv.innerText += '\n1. Ensure the entire nameplate is clearly visible in the frame.';
                        responseDiv.innerText += '\n';
                        responseDiv.innerText += '\n2. Remove any obstructions or dirt from the nameplate, especially around the text and barcode.';
                        responseDiv.innerText += '\n';
                        responseDiv.innerText += '\n3. Verify that the image is sharp and in focus.';
                        responseDiv.innerText += '\n';
                        responseDiv.innerText += '\n4. Clean the camera lens to avoid any blurriness.';
                    }
                })

                .catch(error => {
                    retakeBtn.disabled = false;
                    retakeBtn.style.display = 'inline-block';

                    console.error('API request failed:', error);

                    responseDiv.innerText = 'Please try again.\nServer is busy.';
                });
        }


        captureBtn.addEventListener('click', () => {
            const desiredWidth = cameraView.videoWidth; // ë¹„ë””ì˜¤ì˜ ì‹¤ì œ ë„ˆë¹„ ê°€ì ¸ì˜¤ê¸°
            const desiredHeight = cameraView.videoHeight; // ë¹„ë””ì˜¤ì˜ ì‹¤ì œ ë†’ì´ ê°€ì ¸ì˜¤ê¸°

            canvas.width = desiredWidth;
            canvas.height = desiredHeight;

            var context = canvas.getContext('2d');
            context.drawImage(cameraView, 0, 0, desiredWidth, desiredHeight);


            canvas.toBlob((blob) => {
                capturedImage.src = URL.createObjectURL(blob);
                capturedImage.style.display = 'block';
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';

                const formData = new FormData();

                formData.append('uuid', uuid);
                formData.append('picture', blob, 'captured_image.png');

                sendFormDataToAPI(formData);
            });
        });


        retakeBtn.addEventListener('click', () => {
            capturedImage.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            retakeBtn.style.display = 'none';
            responseDiv.innerText = '';
        });

    </script>

</body>

</html>